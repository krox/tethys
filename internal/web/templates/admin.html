<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>tethys - admin</title>
    <link rel="stylesheet" href="/static/style.css" />
</head>

<body>
    <header class="top">
        <div class="brand">tethys</div>
        <nav class="nav">
            <a href="/">Live</a>
            <a href="/opening">Opening</a>
            <a href="/results">Results</a>
            <a href="/games">Games</a>
            <a href="/download/all.txt">Download all (moves)</a>
            <form method="post" action="/admin/logout" style="display:inline">
                <button type="submit" class="linkish">Logout</button>
            </form>
        </nav>
    </header>

    <main class="container">
        <h1>Admin</h1>

        <div class="card">
            <form method="post" action="/admin/config" class="form">
                <h2>Game</h2>
                <label>Movetime (ms)</label>
                <input name="movetime_ms" value="{{.Cfg.MovetimeMS}}" />
                <label>Max plies (half-moves)</label>
                <input name="max_plies" value="{{.Cfg.MaxPlies}}" />
                <label>Opening min count (no split below)</label>
                <input name="opening_min" value="{{.Cfg.OpeningMin}}" />
                <label class="check">
                    <input type="checkbox" name="book_enabled" {{if .Cfg.BookEnabled}}checked{{end}} />
                    Use opening book
                </label>
                <label>Opening book path</label>
                <input name="book_path" value="{{.Cfg.BookPath}}" />
                <label>Opening book max plies</label>
                <input name="book_max_plies" value="{{.Cfg.BookMaxPlies}}" />

                <h2>Match setup</h2>
                <input type="hidden" name="pair_count" id="pair_count" value="{{len .Pairs}}" />
                <div id="match_setup" class="activation-list">
                    {{range .Pairs}}
                    <div class="activation-row" data-index="{{.Index}}">
                        <input type="hidden" name="pair_a_{{.Index}}" value="{{.AID}}" />
                        <input type="hidden" name="pair_b_{{.Index}}" value="{{.BID}}" />
                        <label class="check compact">
                            <input type="checkbox" name="pair_enabled_{{.Index}}" {{if .Enabled}}checked{{end}} />
                            <span class="activation-label">{{.Label}}</span>
                        </label>
                    </div>
                    {{end}}
                </div>

                <h2>Engines</h2>
                <input type="hidden" name="engine_count" id="engine_count" value="{{len .Engines}}" />
                <div id="engine_list">
                    {{range .Engines}}
                    <div class="engine-card" data-index="{{.Index}}" data-active="{{if .Active}}1{{else}}0{{end}}">
                        <div class="engine-head">
                            {{if .Error}}<span class="error">{{.Error}}</span>{{end}}
                            <div class="engine-actions">
                                <button type="button" class="duplicate-engine">Duplicate</button>
                                <button type="button" class="delete-engine">Delete</button>
                            </div>
                        </div>
                        <div class="engine-grid">
                            <div>
                                <label>Name</label>
                                <input name="engine_name_{{.Index}}" data-field="name" value="{{.Name}}"
                                    placeholder="unique name" />
                            </div>
                            <div>
                                <label>Path</label>
                                <input name="engine_path_{{.Index}}" data-field="path" value="{{.Path}}"
                                    placeholder="/usr/games/stockfish" />
                            </div>
                            <div>
                                <label>Args</label>
                                <input name="engine_args_{{.Index}}" data-field="args" value="{{.Args}}"
                                    placeholder="" />
                            </div>
                            <div class="engine-init">
                                <label>Init commands (one per line)</label>
                                <textarea name="engine_init_{{.Index}}" data-field="init" rows="4">{{.Init}}</textarea>
                            </div>
                        </div>
                    </div>
                    {{end}}
                </div>
                <div class="row">
                    <button type="button" id="add_engine">Add engine</button>
                </div>

                <div class="row">
                    <button type="submit">Save</button>
                </div>
            </form>
        </div>

        <p class="hint">Notes: engine args are split on spaces (no shell quoting). Init commands are sent as-is, then
            `isready`.</p>
    </main>

    <script>
        (function () {
            const list = document.getElementById('engine_list');
            const matchSetup = document.getElementById('match_setup');
            const pairCountEl = document.getElementById('pair_count');
            const countEl = document.getElementById('engine_count');
            const addBtn = document.getElementById('add_engine');

            function newEngineRow(index) {
                const wrapper = document.createElement('div');
                wrapper.className = 'engine-card';
                wrapper.dataset.index = String(index);
                wrapper.dataset.active = '0';
                wrapper.innerHTML = `
                    <div class="engine-head">
                        <div class="engine-actions">
                            <button type="button" class="duplicate-engine">Duplicate</button>
                            <button type="button" class="delete-engine">Delete</button>
                        </div>
                    </div>
                    <div class="engine-grid">
                        <div>
                            <label>Name</label>
                            <input name="engine_name_${index}" data-field="name" value="" placeholder="unique name" />
                        </div>
                        <div>
                            <label>Path</label>
                            <input name="engine_path_${index}" data-field="path" value="" placeholder="/usr/games/stockfish" />
                        </div>
                        <div>
                            <label>Args</label>
                            <input name="engine_args_${index}" data-field="args" value="" placeholder="" />
                        </div>
                        <div class="engine-init">
                            <label>Init commands (one per line)</label>
                            <textarea name="engine_init_${index}" data-field="init" rows="4"></textarea>
                        </div>
                    </div>
                `;
                return wrapper;
            }

            function syncIndices() {
                const cards = Array.from(list.querySelectorAll('.engine-card'));
                cards.forEach((card, index) => {
                    card.dataset.index = String(index);
                    card.querySelectorAll('[data-field]').forEach((el) => {
                        const field = el.getAttribute('data-field');
                        if (!field) return;
                        el.name = `engine_${field}_${index}`;
                    });
                });
                countEl.value = String(cards.length);
                rebuildMatchSetup();
            }

            function collectPairSelections() {
                const selected = new Set();
                matchSetup.querySelectorAll('.activation-row').forEach((row) => {
                    const a = row.querySelector('input[name^="pair_a_"]')?.value || '';
                    const b = row.querySelector('input[name^="pair_b_"]')?.value || '';
                    const checked = row.querySelector('input[type="checkbox"]')?.checked;
                    if (!a || !b || !checked) return;
                    const aNum = Number(a);
                    const bNum = Number(b);
                    const key = aNum < bNum ? `${a}::${b}` : `${b}::${a}`;
                    selected.add(key);
                });
                return selected;
            }

            function rebuildMatchSetup() {
                const selected = collectPairSelections();
                const cards = Array.from(list.querySelectorAll('.engine-card'));
                const names = cards
                    .map((card) => card.querySelector('input[data-field="name"]')?.value.trim() || '')
                    .filter((name) => name.length > 0);

                matchSetup.innerHTML = '';
                let index = 0;
                for (let i = 0; i < names.length; i++) {
                    for (let j = i; j < names.length; j++) {
                        const a = names[i];
                        const b = names[j];
                        const aNum = Number(a);
                        const bNum = Number(b);
                        const key = aNum < bNum ? `${a}::${b}` : `${b}::${a}`;
                        const label = a === b ? `${a} (selfplay)` : `${a} vs ${b}`;
                        const row = document.createElement('div');
                        row.className = 'activation-row';
                        row.dataset.index = String(index);
                        row.innerHTML = `
                            <input type="hidden" name="pair_a_${index}" value="${a}" />
                            <input type="hidden" name="pair_b_${index}" value="${b}" />
                            <label class="check compact">
                                <input type="checkbox" name="pair_enabled_${index}" ${selected.has(key) ? 'checked' : ''} />
                                <span class="activation-label">${label}</span>
                            </label>
                        `;
                        matchSetup.appendChild(row);
                        index++;
                    }
                }
                pairCountEl.value = String(index);
            }

            function collectNames() {
                const names = [];
                list.querySelectorAll('input[data-field="name"]').forEach((el) => {
                    const value = (el.value || '').trim();
                    if (value) names.push(value);
                });
                return names;
            }

            function uniqueName(base) {
                const names = collectNames();
                if (!names.includes(base)) return base;
                let n = 2;
                let candidate = `${base.replace(/\s*\(copy\s*\d*\)\s*$/i, '')} (copy ${n})`;
                while (names.includes(candidate)) {
                    n++;
                    candidate = `${base.replace(/\s*\(copy\s*\d*\)\s*$/i, '')} (copy ${n})`;
                }
                return candidate;
            }

            function bindCardActions(card) {
                const del = card.querySelector('.delete-engine');
                const dup = card.querySelector('.duplicate-engine');

                del.addEventListener('click', () => {
                    card.remove();
                    syncIndices();
                });

                dup.addEventListener('click', () => {
                    const clone = card.cloneNode(true);
                    const nameInput = clone.querySelector('input[data-field="name"]');
                    const errorEl = clone.querySelector('.error');
                    if (errorEl) errorEl.remove();

                    const baseName = nameInput && nameInput.value ? `${nameInput.value.trim()} (copy)` : 'engine (copy)';
                    if (nameInput) nameInput.value = uniqueName(baseName);
                    list.appendChild(clone);
                    syncIndices();
                    bindCardActions(clone);
                });
            }

            addBtn.addEventListener('click', function () {
                const index = parseInt(countEl.value || '0', 10);
                const card = newEngineRow(index);
                list.appendChild(card);
                syncIndices();
                bindCardActions(card);
            });

            list.querySelectorAll('.engine-card').forEach((card) => bindCardActions(card));
            syncIndices();
        })();
    </script>
</body>

</html>