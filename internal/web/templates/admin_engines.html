<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>tethys - engine settings</title>
    <link rel="stylesheet" href="/static/style.css" />
</head>

<body>
    <header class="top">
        <div class="brand">tethys</div>
    </header>

    <div class="shell">
        <aside class="sidebar">
            <nav class="side-nav">
                <a href="/" {{if eq .Page "live"}}class="active"{{end}}>Live View</a>
                <a href="/opening" {{if eq .Page "opening"}}class="active"{{end}}>Opening Explorer</a>
                <a href="/results" {{if eq .Page "ranking"}}class="active"{{end}}>Ranking</a>
                <a href="/games" {{if eq .Page "games"}}class="active"{{end}}>Game Database</a>
                <a href="/admin/settings" {{if eq .Page "settings"}}class="active"{{end}}>Global Settings</a>
                <a href="/admin/matches" {{if eq .Page "matches"}}class="active"{{end}}>Match Settings</a>
                <a href="/admin/engines" {{if eq .Page "engines"}}class="active"{{end}}>Engine Settings</a>
                <form method="post" action="/admin/logout">
                    <button type="submit" class="linkish">Logout</button>
                </form>
            </nav>
        </aside>

        <main class="container">
            <h1>Engine Settings</h1>

        <div class="card">
            <form method="post" action="/admin/engines" class="form">
                <input type="hidden" name="engine_count" id="engine_count" value="{{len .Engines}}" />
                <div id="engine_list">
                    {{range .Engines}}
                    <div class="engine-card" data-index="{{.Index}}">
                        <div class="engine-head">
                            {{if .Error}}<span class="error">{{.Error}}</span>{{end}}
                            <div class="engine-actions">
                                <button type="button" class="duplicate-engine">Duplicate</button>
                                <button type="button" class="delete-engine">Delete</button>
                            </div>
                        </div>
                        <div class="engine-grid">
                            <div>
                                <label>Name</label>
                                <input name="engine_name_{{.Index}}" data-field="name" value="{{.Name}}"
                                    placeholder="unique name" />
                            </div>
                            <div>
                                <label>Path</label>
                                <input name="engine_path_{{.Index}}" data-field="path" value="{{.Path}}"
                                    placeholder="/usr/games/stockfish" />
                            </div>
                            <div>
                                <label>Args</label>
                                <input name="engine_args_{{.Index}}" data-field="args" value="{{.Args}}"
                                    placeholder="" />
                            </div>
                            <div class="engine-init">
                                <label>Init commands (one per line)</label>
                                <textarea name="engine_init_{{.Index}}" data-field="init" rows="4">{{.Init}}</textarea>
                            </div>
                        </div>
                    </div>
                    {{end}}
                </div>
                <div class="row">
                    <button type="button" id="add_engine">Add engine</button>
                </div>
                <div class="row">
                    <button type="submit">Save</button>
                </div>
            </form>
        </div>

            <p class="hint">Notes: engine args are split on spaces (no shell quoting). Init commands are sent as-is, then
                `isready`.</p>
        </main>
    </div>

    <script>
        (function () {
            const list = document.getElementById('engine_list');
            const countEl = document.getElementById('engine_count');
            const addBtn = document.getElementById('add_engine');

            function newEngineRow(index) {
                const wrapper = document.createElement('div');
                wrapper.className = 'engine-card';
                wrapper.dataset.index = String(index);
                wrapper.innerHTML = `
                    <div class="engine-head">
                        <div class="engine-actions">
                            <button type="button" class="duplicate-engine">Duplicate</button>
                            <button type="button" class="delete-engine">Delete</button>
                        </div>
                    </div>
                    <div class="engine-grid">
                        <div>
                            <label>Name</label>
                            <input name="engine_name_${index}" data-field="name" value="" placeholder="unique name" />
                        </div>
                        <div>
                            <label>Path</label>
                            <input name="engine_path_${index}" data-field="path" value="" placeholder="/usr/games/stockfish" />
                        </div>
                        <div>
                            <label>Args</label>
                            <input name="engine_args_${index}" data-field="args" value="" placeholder="" />
                        </div>
                        <div class="engine-init">
                            <label>Init commands (one per line)</label>
                            <textarea name="engine_init_${index}" data-field="init" rows="4"></textarea>
                        </div>
                    </div>
                `;
                return wrapper;
            }

            function collectNames() {
                const names = [];
                list.querySelectorAll('input[data-field="name"]').forEach((el) => {
                    const value = (el.value || '').trim();
                    if (value) names.push(value);
                });
                return names;
            }

            function uniqueName(base) {
                const names = collectNames();
                if (!names.includes(base)) return base;
                let n = 2;
                let candidate = `${base.replace(/\s*\(copy\s*\d*\)\s*$/i, '')} (copy ${n})`;
                while (names.includes(candidate)) {
                    n++;
                    candidate = `${base.replace(/\s*\(copy\s*\d*\)\s*$/i, '')} (copy ${n})`;
                }
                return candidate;
            }

            function syncIndices() {
                const cards = Array.from(list.querySelectorAll('.engine-card'));
                cards.forEach((card, index) => {
                    card.dataset.index = String(index);
                    card.querySelectorAll('[data-field]').forEach((el) => {
                        const field = el.getAttribute('data-field');
                        if (!field) return;
                        el.name = `engine_${field}_${index}`;
                    });
                });
                countEl.value = String(cards.length);
            }

            function bindCardActions(card) {
                const del = card.querySelector('.delete-engine');
                const dup = card.querySelector('.duplicate-engine');

                del.addEventListener('click', () => {
                    card.remove();
                    syncIndices();
                });

                dup.addEventListener('click', () => {
                    const clone = card.cloneNode(true);
                    const nameInput = clone.querySelector('input[data-field="name"]');
                    const errorEl = clone.querySelector('.error');
                    if (errorEl) errorEl.remove();

                    const baseName = nameInput && nameInput.value ? `${nameInput.value.trim()} (copy)` : 'engine (copy)';
                    if (nameInput) nameInput.value = uniqueName(baseName);

                    list.appendChild(clone);
                    syncIndices();
                    bindCardActions(clone);
                });
            }

            addBtn.addEventListener('click', function () {
                const index = parseInt(countEl.value || '0', 10);
                const card = newEngineRow(index);
                list.appendChild(card);
                syncIndices();
                bindCardActions(card);
            });

            list.querySelectorAll('.engine-card').forEach((card) => bindCardActions(card));
            syncIndices();
        })();
    </script>
</body>

</html>