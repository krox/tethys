<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>tethys - engine settings</title>
    <link rel="stylesheet" href="/static/style.css" />
</head>

<body>
    <header class="top">
        <div class="brand">tethys</div>
    </header>

    <div class="shell">
        <aside class="sidebar">
            <nav class="side-nav">
                <a href="/" {{if eq .Page "live" }}class="active" {{end}}>Live View</a>
                <a href="/opening" {{if eq .Page "opening" }}class="active" {{end}}>Opening Explorer</a>
                <a href="/book" {{if eq .Page "book" }}class="active" {{end}}>Book Explorer</a>
                <a href="/results" {{if eq .Page "ranking" }}class="active" {{end}}>Ranking</a>
                <a href="/games" {{if eq .Page "games" }}class="active" {{end}}>Game Database</a>
                <a href="/admin/settings" {{if eq .Page "settings" }}class="active" {{end}}>Global Settings</a>
                <a href="/admin/matches" {{if eq .Page "matches" }}class="active" {{end}}>Match Settings</a>
                <a href="/admin/engines" {{if eq .Page "engines" }}class="active" {{end}}>Engine Settings</a>
                <form method="post" action="/admin/logout">
                    <button type="submit" class="linkish">Logout</button>
                </form>
            </nav>
        </aside>

        <main class="container">
            <h1>Engine Settings</h1>

            <div class="card">
                <div class="engine-actions-bar">
                    <form method="post" action="/admin/engines/upload" enctype="multipart/form-data"
                        class="engine-upload-form form">
                        <input type="file" name="engine_upload" id="engine_upload_input" class="hidden" />
                        <button type="button" id="upload_engine_btn">Upload engine</button>
                    </form>
                    <button type="button" id="add_external_btn">Add external</button>
                </div>
                <dialog id="external_engine_dialog" class="engine-dialog">
                    <form method="post" action="/admin/engines/add-external" class="form">
                        <h3>Add external engine</h3>
                        <label>Engine path</label>
                        <input name="engine_path" placeholder="/usr/games/stockfish" required />
                        <label>Display name (optional)</label>
                        <input name="engine_name" placeholder="stockfish" />
                        <div class="row">
                            <button type="submit">Add</button>
                            <button type="button" id="external_cancel_btn">Cancel</button>
                        </div>
                    </form>
                </dialog>
                <form method="post" action="/admin/engines" class="form">
                    <input type="hidden" name="engine_count" id="engine_count" value="{{len .Engines}}" />
                    <div id="engine_list">
                        {{range .Engines}}
                        <div class="engine-card" data-index="{{.Index}}">
                            <input type="hidden" name="engine_id_{{.Index}}" value="{{.ID}}" />
                            <input type="hidden" name="engine_source_{{.Index}}" data-field="source"
                                value="{{.Source}}" />
                            <input type="hidden" name="engine_path_{{.Index}}" data-field="path"
                                value="{{if eq .Source " upload"}}{{.StoredPath}}{{else}}{{.Path}}{{end}}" />
                            <div class="engine-top">
                                <div class="engine-row">
                                    <span>#{{.ID}}</span>
                                    <input name="engine_name_{{.Index}}" data-field="name" value="{{.Name}}"
                                        placeholder="unique name" />
                                </div>
                                <div class="engine-actions">
                                    <div class="engine-actions-row">
                                        <button type="submit" class="duplicate-engine"
                                            formaction="/admin/engines/duplicate" formmethod="post" name="engine_id"
                                            value="{{.ID}}">Duplicate</button>
                                        <button type="button" class="delete-engine" {{if or (gt .Games 0) (gt .Matchups
                                            0)}}disabled{{end}}>
                                            Delete
                                        </button>
                                        <button type="submit" class="danger" formaction="/admin/engines/prune"
                                            formmethod="post" name="engine_id" value="{{.ID}}">
                                            Delete games/matchups
                                        </button>
                                    </div>

                                </div>
                            </div>
                            <div class="engine-row">
                                <div>
                                    <label>Init commands</label>
                                    <textarea name="engine_init_{{.Index}}" data-field="init"
                                        rows="2">{{.Init}}</textarea>
                                </div>
                                <div>
                                    <label>Args</label>
                                    <input name="engine_args_{{.Index}}" data-field="args" value="{{.Args}}"
                                        placeholder="" />
                                </div>
                            </div>

                            <div class="engine-meta">
                                <span class="hint">{{.Games}} games</span>
                                <span class="hint">{{.Matchups}}matchups</span>
                                <span class="hint">{{if eq .Source "upload"}}Uploaded:
                                    {{.UploadName}}{{else}}Path:{{.Path}}{{end}}</span>
                                {{if .Error}}<span class="error">{{.Error}}</span>{{end}}
                            </div>

                        </div>
                        {{end}}
                    </div>
                    <div class="row">
                        <button type="submit">Save</button>
                    </div>
                </form>
            </div>

            <p class="hint">Notes: engine args are split on spaces (no shell quoting). Init commands are sent as-is,
                then
                `isready`.</p>
        </main>
    </div>

    <script>
        (function () {
            const list = document.getElementById('engine_list');
            const countEl = document.getElementById('engine_count');
            function syncIndices() {
                const cards = Array.from(list.querySelectorAll('.engine-card'));
                cards.forEach((card, index) => {
                    card.dataset.index = String(index);
                    const idInput = card.querySelector('input[name^="engine_id_"]');
                    if (idInput) {
                        idInput.name = `engine_id_${index}`;
                    }
                    card.querySelectorAll('[data-field]').forEach((el) => {
                        const field = el.getAttribute('data-field');
                        if (!field) return;
                        el.name = `engine_${field}_${index}`;
                    });
                });
                countEl.value = String(cards.length);
            }

            function bindCardActions(card) {
                const del = card.querySelector('.delete-engine');
                if (!del) return;

                del.addEventListener('click', () => {
                    if (del.disabled) return;
                    card.remove();
                    syncIndices();
                });
            }

            const uploadInput = document.getElementById('engine_upload_input');
            const uploadBtn = document.getElementById('upload_engine_btn');
            if (uploadBtn && uploadInput) {
                uploadBtn.addEventListener('click', () => uploadInput.click());
                uploadInput.addEventListener('change', () => {
                    if (!uploadInput.files || uploadInput.files.length === 0) return;
                    uploadInput.closest('form')?.submit();
                });
            }

            const externalBtn = document.getElementById('add_external_btn');
            const externalDialog = document.getElementById('external_engine_dialog');
            const externalCancel = document.getElementById('external_cancel_btn');
            if (externalBtn && externalDialog) {
                externalBtn.addEventListener('click', () => externalDialog.showModal());
            }
            if (externalCancel && externalDialog) {
                externalCancel.addEventListener('click', () => externalDialog.close());
            }

            list.querySelectorAll('.engine-card').forEach((card) => bindCardActions(card));
            syncIndices();
        })();
    </script>
</body>

</html>